<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en-US">
    <title>Journal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding: 40px 20px;
            color: #1a1a1a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 60px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 0.95em;
            color: #666;
            font-weight: 400;
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 25px 35px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            text-align: center;
            min-width: 160px;
            border: 1px solid #e8e8e8;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #1a1a1a;
            display: block;
            line-height: 1;
        }

        .stat-label {
            color: #666;
            font-size: 0.8em;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 500;
        }

        .prompt-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e8e8e8;
            position: relative;
        }

        .prompt-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        .prompt-label {
            color: #999;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .prompt-text {
            font-size: 1.15em;
            color: #333;
            line-height: 1.6;
        }

        .refresh-prompt {
            position: absolute;
            top: 25px;
            right: 25px;
            background: transparent;
            border: 1px solid #e0e0e0;
            color: #666;
            cursor: pointer;
            font-size: 0.9em;
            padding: 6px 12px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .refresh-prompt:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .writing-area {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid #e8e8e8;
        }

        .writing-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            flex-wrap: wrap;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .goal-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .goal-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .goal-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .goal-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .timer {
            font-size: 1.1em;
            color: #666;
            font-weight: 500;
            margin-left: auto;
        }

        .date-picker-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            font-family: inherit;
        }

        .date-select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            font-family: inherit;
            margin-right: 5px;
        }

        .date-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }

        /* Force English in date picker */
        .date-input::-webkit-datetime-edit-month-field,
        .date-input::-webkit-datetime-edit-day-field,
        .date-input::-webkit-datetime-edit-year-field {
            color: #666;
        }

        .date-input:hover {
            border-color: #ccc;
        }

        .date-input:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .photo-section {
            margin-bottom: 25px;
        }

        .photo-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .photo-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .photo-preview {
            margin-top: 20px;
            display: none;
            position: relative;
        }

        .photo-preview.has-photo {
            display: block;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .remove-photo {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: 300;
        }

        .remove-photo:hover {
            background: #1a1a1a;
        }

        .formatting-toolbar {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            padding: 8px;
            background: #f8f8f8;
            border-radius: 6px;
            flex-wrap: wrap;
        }

        .format-btn {
            padding: 8px 14px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .format-btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }

        .format-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .rich-editor {
            min-height: 400px;
            border: none;
            font-size: 1.05em;
            line-height: 1.8;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            color: #1a1a1a;
            outline: none;
            background: transparent;
            overflow-y: auto;
        }

        .rich-editor:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }

        .rich-editor h1 {
            font-size: 2.2em;
            font-weight: 700;
            line-height: 1.2;
            margin: 0.5em 0;
            letter-spacing: -0.5px;
        }

        .rich-editor h2 {
            font-size: 1.6em;
            font-weight: 600;
            line-height: 1.3;
            margin: 0.6em 0;
            letter-spacing: -0.3px;
        }

        .rich-editor h3 {
            font-size: 1.3em;
            font-weight: 600;
            line-height: 1.4;
            margin: 0.5em 0;
        }

        .rich-editor p {
            font-size: 1em;
            line-height: 1.8;
            margin: 0.8em 0;
        }

        .rich-editor blockquote {
            border-left: 3px solid #1a1a1a;
            padding-left: 20px;
            margin: 1.5em 0;
            font-style: italic;
            color: #555;
        }

        .rich-editor strong {
            font-weight: 600;
        }

        .rich-editor em {
            font-style: italic;
        }

        .word-count {
            text-align: right;
            color: #999;
            font-size: 0.8em;
            margin-top: 15px;
            font-weight: 400;
        }

        .spellcheck-note {
            font-size: 0.75em;
            color: #999;
            margin-top: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 6px;
            line-height: 1.5;
        }

        .spelling-error {
            background: transparent;
            border-bottom: 1px dotted #ddd;
            cursor: pointer;
        }

        .spelling-error:hover {
            background: #fee;
            border-bottom-color: #dc2626;
        }

        .spell-menu {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            font-size: 0.9em;
        }

        .spell-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .spell-menu-item:hover {
            background: #f5f5f5;
        }

        .spell-menu-suggestion {
            font-weight: 500;
            color: #1a1a1a;
        }

        .spell-menu-ignore {
            border-top: 1px solid #f0f0f0;
            color: #999;
            font-size: 0.85em;
        }

        .save-btn {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            width: 100%;
            font-weight: 500;
        }

        .save-btn:hover {
            background: #333;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .view-history-btn {
            background: white;
            color: #666;
            border: 1px solid #e0e0e0;
            padding: 12px 35px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            font-weight: 500;
            margin-top: 12px;
        }

        .view-history-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .calendar {
            background: white;
            padding: 35px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
            border: 1px solid #e8e8e8;
        }

        .calendar-title {
            font-size: 1.3em;
            margin-bottom: 25px;
            color: #1a1a1a;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
            gap: 6px;
            max-width: 100%;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: #f5f5f5;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e8e8e8;
        }

        .calendar-day:hover {
            transform: scale(1.05);
            background: #e8e8e8;
        }

        .calendar-day.written {
            background: #1a1a1a;
            border-color: #1a1a1a;
        }

        .calendar-day.today {
            border: 2px solid #666;
            box-shadow: 0 0 0 1px #666;
        }

        .calendar-day:hover::after {
            content: attr(data-date);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75em;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 8px;
        }

        .success-message {
            background: #1a1a1a;
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
            display: none;
            animation: slideDown 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 40px;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 30px 35px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
            z-index: 10;
        }

        .modal-header h2 {
            color: #1a1a1a;
            font-size: 1.8em;
            font-weight: 600;
        }

        .modal-header h2[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
        }

        .modal-header h2[contenteditable="true"]:focus {
            outline: 2px solid #1a1a1a;
            outline-offset: 4px;
            border-radius: 4px;
            padding: 4px 8px;
        }

        .close-modal {
            background: transparent;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: #1a1a1a;
        }

        .modal-body {
            padding: 35px;
        }

        .entries-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .entry-card {
            background: #fafafa;
            border-radius: 8px;
            padding: 25px;
            border-left: 4px solid #1a1a1a;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #e8e8e8;
        }

        .entry-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            background: white;
        }

        .entry-card.expanded {
            background: white;
            border-left-width: 4px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .entry-date {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 1.05em;
        }

        .entry-meta {
            color: #999;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .entry-preview {
            color: #333;
            line-height: 1.6;
            font-size: 1em;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .entry-card.expanded .entry-preview {
            display: block;
            -webkit-line-clamp: unset;
        }

        .entry-preview h1,
        .entry-preview h2,
        .entry-preview h3 {
            margin: 0.5em 0;
        }

        .entry-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .entry-actions {
            display: none;
            gap: 10px;
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid #e8e8e8;
        }

        .entry-card.expanded .entry-actions {
            display: flex;
        }

        .entry-btn {
            padding: 10px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .edit-btn {
            background: #1a1a1a;
            color: white;
        }

        .edit-btn:hover {
            background: #333;
        }

        .delete-btn {
            background: #dc2626;
            color: white;
        }

        .delete-btn:hover {
            background: #b91c1c;
        }

        .collapse-btn {
            background: #f0f0f0;
            color: #666;
        }

        .collapse-btn:hover {
            background: #e0e0e0;
        }

        .no-entries {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-entries-icon {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .no-entries h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .project-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .new-project-btn {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .new-project-btn:hover {
            background: #333;
        }

        .project-filters {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #f5f5f5;
        }

        .filter-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .projects-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .project-card {
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #1a1a1a;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #e8e8e8;
        }

        .project-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            background: white;
        }

        .project-card.solved {
            border-left-color: #22c55e;
            opacity: 0.7;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .project-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 1.1em;
            flex: 1;
        }

        .project-goal {
            font-size: 0.9em;
            color: #666;
            margin: 10px 0;
            font-style: italic;
        }

        .project-stats {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .stat-badge {
            font-size: 0.75em;
            padding: 4px 10px;
            background: #f0f0f0;
            border-radius: 12px;
            color: #666;
            font-weight: 500;
        }

        .project-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-status.active {
            background: #fef3c7;
            color: #92400e;
        }

        .project-status.solved {
            background: #d1fae5;
            color: #065f46;
        }

        .project-meta {
            color: #999;
            font-size: 0.85em;
            margin-top: 8px;
        }

        .project-detail-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .project-canvas {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .canvas-section {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }

        .canvas-section:hover {
            border-color: #ccc;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .canvas-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .canvas-section-title {
            font-size: 1em;
            font-weight: 600;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .canvas-section-content {
            color: #333;
            line-height: 1.6;
            min-height: 60px;
            padding: 15px;
            background: #fafafa;
            border-radius: 6px;
            border: 2px dashed transparent;
            cursor: text;
            transition: all 0.2s;
        }

        .canvas-section-content:hover {
            background: #f5f5f5;
            border-color: #e0e0e0;
        }

        .canvas-section-content:focus {
            outline: none;
            background: white;
            border-color: #1a1a1a;
        }

        .canvas-section-content[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
        }

        /* Formatting styles for project canvas */
        .canvas-section-content h1,
        .canvas-item-content h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 0.5em 0;
            color: #1a1a1a;
        }

        .canvas-section-content h2,
        .canvas-item-content h2 {
            font-size: 1.4em;
            font-weight: 600;
            margin: 0.4em 0;
            color: #1a1a1a;
        }

        .canvas-section-content h3,
        .canvas-item-content h3 {
            font-size: 1.2em;
            font-weight: 600;
            margin: 0.3em 0;
            color: #333;
        }

        .canvas-section-content strong,
        .canvas-item-content strong {
            font-weight: 700;
        }

        .canvas-section-content em,
        .canvas-item-content em {
            font-style: italic;
        }

        .canvas-section-content blockquote,
        .canvas-item-content blockquote {
            border-left: 4px solid #e0e0e0;
            padding-left: 16px;
            margin: 12px 0;
            color: #666;
            font-style: italic;
        }

        .canvas-toolbar {
            display: none;
            gap: 4px;
            padding: 8px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 8px;
        }

        .canvas-toolbar.active {
            display: flex;
        }

        .canvas-toolbar-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            color: #666;
            font-weight: 500;
        }

        .canvas-toolbar-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .canvas-toolbar-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .canvas-section-empty {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            border-radius: 6px;
            cursor: pointer;
            border: 2px dashed #e0e0e0;
            transition: all 0.2s;
        }

        .canvas-section-empty:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .canvas-list-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .add-item-btn {
            padding: 12px;
            background: #f8f8f8;
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            color: #666;
            cursor: pointer;
            text-align: center;
            font-size: 0.9em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .add-item-btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
            color: #333;
        }

        .canvas-item {
            background: #fafafa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #1a1a1a;
            position: relative;
        }

        .canvas-item.idea {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .canvas-item.action {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .canvas-item.action.done {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .canvas-item.progress {
            border-left-color: #8b5cf6;
            background: #f5f3ff;
        }

        .canvas-item-content {
            color: #1a1a1a;
            margin-bottom: 8px;
            min-height: 40px;
            padding: 8px;
            border-radius: 4px;
            cursor: text;
            line-height: 1.5;
        }

        .canvas-item-content:focus {
            outline: none;
            background: white;
        }

        .canvas-item-content[contenteditable="true"]:empty:before {
            content: "Write here...";
            color: #999;
            font-style: italic;
        }

        .canvas-item-meta {
            font-size: 0.75em;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-item-actions {
            display: flex;
            gap: 8px;
        }

        .canvas-item-btn {
            padding: 4px 10px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            font-size: 0.85em;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .canvas-item-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .toggle-action-btn {
            color: #3b82f6;
        }

        .delete-item-btn {
            color: #dc2626;
        }

        .project-freeform-notes {
            min-height: 300px;
            padding: 20px;
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            color: #1a1a1a;
            line-height: 1.8;
            font-size: 1em;
            cursor: text;
            transition: all 0.2s;
        }

        .project-freeform-notes:hover {
            border-color: #ccc;
        }

        .project-freeform-notes:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }

        .project-freeform-notes[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
        }

        .project-notes-word-count {
            text-align: right;
            color: #999;
            font-size: 0.8em;
            margin-top: 10px;
            font-weight: 400;
        }

        .project-action-btn {
            padding: 10px 20px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .project-action-btn:hover {
            background: #f5f5f5;
        }

        .delete-project-btn {
            margin-left: auto;
            border-color: #dc2626;
            color: #dc2626;
        }

        .delete-project-btn:hover {
            background: #dc2626;
            color: white;
        }

        .project-notes-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .project-note {
            background: #fafafa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
        }

        .project-note-date {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .project-note-content {
            color: #333;
            line-height: 1.6;
        }

        .project-note-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            gap: 10px;
        }

        .note-action-btn {
            padding: 6px 14px;
            border: none;
            background: #f0f0f0;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .note-action-btn:hover {
            background: #e0e0e0;
        }

        .note-delete-btn {
            background: #fee;
            color: #dc2626;
        }

        .note-delete-btn:hover {
            background: #dc2626;
            color: white;
        }

        .search-filter {
            margin-bottom: 25px;
            position: sticky;
            top: 94px;
            background: white;
            padding: 15px 0;
            z-index: 9;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
            background: white;
            color: #1a1a1a;
        }

        .search-input:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .search-input::placeholder {
            color: #999;
        }

        @media (max-width: 600px) {
            body {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .header p {
                font-size: 0.9em;
            }
            
            .stats {
                gap: 12px;
            }
            
            .stat-card {
                min-width: 130px;
                padding: 20px 25px;
            }

            .stat-number {
                font-size: 2em;
            }

            .prompt-card {
                padding: 25px 20px;
            }

            .refresh-prompt {
                top: 20px;
                right: 20px;
            }

            .writing-area {
                padding: 30px 25px;
            }

            .modal-content {
                margin: 0;
                max-height: 95vh;
            }

            .modal-header {
                padding: 25px 20px;
            }

            .modal-header h2 {
                font-size: 1.5em;
            }

            .modal-body {
                padding: 25px 20px;
            }

            .entry-card {
                padding: 20px;
            }

            .calendar {
                padding: 25px 20px;
            }

            .formatting-toolbar {
                gap: 3px;
                padding: 6px;
            }

            .format-btn {
                padding: 6px 10px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Journal</h1>
            <p>Learn, reflect, grow. Every day, a step forward.</p>
        </div>

        <div class="success-message" id="successMessage">
            <span id="successText">Entry saved!</span>
        </div>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-number" id="streakCount">0</span>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalEntries">0</span>
                <div class="stat-label">Total Entries</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalWords">0</span>
                <div class="stat-label">Total Words</div>
            </div>
        </div>

        <div class="prompt-card" id="promptCard">
            <button class="refresh-prompt" id="refreshPrompt" title="Get new prompt">↻</button>
            <div class="prompt-label">Today's Prompt</div>
            <div class="prompt-text" id="promptText">Loading...</div>
        </div>

        <div class="writing-area">
            <div class="writing-controls">
                <div class="goal-selector">
                    <button class="goal-btn active" data-goal="words">100 words</button>
                    <button class="goal-btn" data-goal="time">5 minutes</button>
                    <button class="goal-btn" data-goal="sentence">1 sentence</button>
                </div>
                <div class="date-picker-container">
                    <label for="entryDate" class="date-label">Entry Date:</label>
                    <input type="date" id="entryDate" class="date-input" lang="en-US">
                </div>
                <div class="timer" id="timer"></div>
            </div>

            <div class="photo-section">
                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                <button class="photo-btn" id="photoBtn">Add Photo</button>
                <div class="photo-preview" id="photoPreview"></div>
            </div>

            <div class="formatting-toolbar">
                <button class="format-btn" data-format="h1" title="Large Title">Title</button>
                <button class="format-btn" data-format="h2" title="Subtitle">Subtitle</button>
                <button class="format-btn" data-format="h3" title="Heading">Heading</button>
                <button class="format-btn" data-format="p" title="Normal Text">Normal</button>
                <button class="format-btn" data-format="bold" title="Bold"><strong>B</strong></button>
                <button class="format-btn" data-format="italic" title="Italic"><em>I</em></button>
                <button class="format-btn" data-format="quote" title="Quote">Quote</button>
            </div>

            <div id="journalEntry" class="rich-editor" contenteditable="true" spellcheck="true" lang="en-US" data-placeholder="Start writing your thoughts..."></div>
            
            <div class="word-count" id="wordCount">0 words</div>
            
            <div class="spellcheck-note">
                ✓ Custom spell checker enabled! Misspelled words will have red wavy underlines. Right-click for suggestions.
            </div>
            
            <button class="save-btn" id="saveBtn">Save Entry</button>
            <button class="view-history-btn" id="viewHistoryBtn">View All Entries</button>
            <button class="view-history-btn" id="viewProjectsBtn">My Projects</button>
        </div>

        <div class="calendar">
            <div class="calendar-title">Your Writing Journey (Last 60 Days)</div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Your Journal Entries</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-filter">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search your entries...">
                </div>
                <div class="entries-list" id="entriesList">
                    <!-- Entries will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Modal -->
    <div class="modal" id="projectsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>My Projects</h2>
                <button class="close-modal" id="closeProjectsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="project-controls">
                    <button class="new-project-btn" id="newProjectBtn" onclick="createNewProject()">+ New Project</button>
                    <div class="project-filters">
                        <button class="filter-btn active" data-filter="active">Active</button>
                        <button class="filter-btn" data-filter="solved">Solved</button>
                        <button class="filter-btn" data-filter="all">All</button>
                    </div>
                </div>
                <div class="projects-list" id="projectsList">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div class="modal" id="projectDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectDetailTitle" 
                    contenteditable="true" 
                    data-placeholder="Click to name your project..."
                    onblur="updateProjectTitle(currentProjectId, this.textContent)"
                    style="cursor: text; outline: none; min-width: 200px;">Project Title</h2>
                <button class="close-modal" id="closeProjectDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="project-detail-controls">
                    <button class="project-action-btn" id="markSolvedBtn">Mark as Solved</button>
                    <button class="project-action-btn delete-project-btn" id="deleteProjectBtn">Delete</button>
                </div>
                <div class="project-canvas" id="projectCanvas">
                    <!-- Project canvas will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const prompts = [
            "What made you smile today?",
            "Describe a challenge you faced and how you handled it.",
            "What are you grateful for right now?",
            "If today was a movie, what genre would it be and why?",
            "What's one thing you learned about yourself today?",
            "Write about a conversation that stuck with you.",
            "What would you tell your younger self about today?",
            "Describe your perfect day. How close was today to that?",
            "What's something you're looking forward to?",
            "If you could relive one moment from today, which would it be?",
            "What emotions did you experience today and why?",
            "Write a letter to your future self about today.",
            "What would you change about today if you could?",
            "Describe the most interesting thing you saw or heard today.",
            "What's one small victory you had today?",
            "How did you take care of yourself today?",
            "What's on your mind right now?",
            "Describe your day using only five words, then explain.",
            "What did you create, make, or accomplish today?",
            "Who made a difference in your day and how?",
            "What's something you want to remember about this moment in your life?",
            "If today had a soundtrack, what would be playing?",
            "What's a problem you're working through right now?",
            "Describe a moment of peace you experienced today.",
            "What would you like tomorrow to bring?"
        ];

        let currentGoal = 'words';
        let startTime = null;
        let timerInterval = null;
        let currentPhoto = null;
        let currentEntryDate = null;
        let spellChecker = null;
        let spellCheckTimeout = null;
        let currentSpellMenu = null;
        let ignoredWords = new Set();
        let currentProjectFilter = 'active';
        let currentProjectId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date as default
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            
            document.getElementById('entryDate').value = todayStr;
            currentEntryDate = todayStr;
            
            loadData();
            setRandomPrompt();
            renderCalendar();
            updateStats();
            setupEventListeners();
            checkTodayEntry();
            
            console.log('Journal initialized');
        });

        function setupEventListeners() {
            // Goal buttons
            document.querySelectorAll('.goal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentGoal = btn.dataset.goal;
                    resetTimer();
                });
            });

            // Refresh prompt
            document.getElementById('refreshPrompt').addEventListener('click', (e) => {
                e.stopPropagation();
                setRandomPrompt();
            });

            // Prompt card click
            document.getElementById('promptCard').addEventListener('click', () => {
                document.getElementById('journalEntry').focus();
            });

            // Rich editor input
            const editor = document.getElementById('journalEntry');
            editor.addEventListener('input', () => {
                updateWordCount();
                if (!startTime && editor.textContent.trim().length > 0) {
                    startTimer();
                }
                
                // Custom spell checking disabled - using browser's built-in spellcheck instead
            });

            // Browser spellcheck is already enabled via spellcheck="true" attribute

            // Formatting toolbar
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const format = btn.dataset.format;
                    applyFormat(format);
                });
            });

            // Photo upload
            document.getElementById('photoBtn').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });

            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);

            // Date picker
            document.getElementById('entryDate').addEventListener('change', (e) => {
                currentEntryDate = e.target.value;
                loadEntryForDate(currentEntryDate);
            });

            // Save button
            document.getElementById('saveBtn').addEventListener('click', saveEntry);

            // Close spell menu when clicking outside
            document.addEventListener('click', (e) => {
                if (currentSpellMenu && !currentSpellMenu.contains(e.target) && !e.target.classList.contains('spelling-error')) {
                    closeSpellMenu();
                }
            });

            // View history button
            document.getElementById('viewHistoryBtn').addEventListener('click', openHistoryModal);
            
            // View projects button
            document.getElementById('viewProjectsBtn').addEventListener('click', openProjectsModal);
            
            // Close modal
            document.getElementById('closeModal').addEventListener('click', closeHistoryModal);
            document.getElementById('historyModal').addEventListener('click', (e) => {
                if (e.target.id === 'historyModal') {
                    closeHistoryModal();
                }
            });

            // Projects modal controls
            document.getElementById('closeProjectsModal').addEventListener('click', closeProjectsModal);
            document.getElementById('projectsModal').addEventListener('click', (e) => {
                if (e.target.id === 'projectsModal') {
                    closeProjectsModal();
                }
            });

            const newProjectBtn = document.getElementById('newProjectBtn');
            if (newProjectBtn) {
                newProjectBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('New Project button clicked!');
                    createNewProject();
                });
            } else {
                console.error('newProjectBtn not found!');
            }

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentProjectFilter = btn.dataset.filter;
                    loadProjects();
                });
            });

            // Project detail modal
            document.getElementById('closeProjectDetailModal').addEventListener('click', closeProjectDetailModal);
            document.getElementById('projectDetailModal').addEventListener('click', (e) => {
                if (e.target.id === 'projectDetailModal') {
                    closeProjectDetailModal();
                }
            });

            document.getElementById('markSolvedBtn').addEventListener('click', toggleProjectStatus);
            document.getElementById('deleteProjectBtn').addEventListener('click', deleteProject);

            // Search entries
            document.getElementById('searchInput').addEventListener('input', filterEntries);

            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
        }

        function applyFormat(format) {
            const editor = document.getElementById('journalEntry');
            editor.focus();
            
            switch(format) {
                case 'h1':
                    document.execCommand('formatBlock', false, '<h1>');
                    break;
                case 'h2':
                    document.execCommand('formatBlock', false, '<h2>');
                    break;
                case 'h3':
                    document.execCommand('formatBlock', false, '<h3>');
                    break;
                case 'p':
                    document.execCommand('formatBlock', false, '<p>');
                    break;
                case 'bold':
                    document.execCommand('bold', false, null);
                    break;
                case 'italic':
                    document.execCommand('italic', false, null);
                    break;
                case 'quote':
                    document.execCommand('formatBlock', false, '<blockquote>');
                    break;
            }
        }

        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentPhoto = event.target.result;
                    displayPhoto(currentPhoto);
                };
                reader.readAsDataURL(file);
            }
        }

        function displayPhoto(photoData) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `
                <img src="${photoData}" alt="Journal photo">
                <button class="remove-photo" onclick="removePhoto()">×</button>
            `;
            preview.classList.add('has-photo');
        }

        function removePhoto() {
            currentPhoto = null;
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            preview.classList.remove('has-photo');
            document.getElementById('photoInput').value = '';
        }

        function setRandomPrompt() {
            const promptText = document.getElementById('promptText');
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            promptText.textContent = randomPrompt;
        }

        function updateWordCount() {
            const editor = document.getElementById('journalEntry');
            const text = editor.textContent || editor.innerText;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            document.getElementById('wordCount').textContent = `${words} words`;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function resetTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = null;
            document.getElementById('timer').textContent = '';
        }

        function saveEntry() {
            const editor = document.getElementById('journalEntry');
            const html = editor.innerHTML.trim();
            const text = editor.textContent.trim();
            
            if (!text) {
                alert('Please write something before saving!');
                return;
            }

            const entryDate = currentEntryDate || new Date().toISOString().split('T')[0];
            const entries = getEntries();
            
            const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
            
            entries[entryDate] = {
                html: html,
                text: text,
                wordCount: wordCount,
                photo: currentPhoto,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('journalEntries', JSON.stringify(entries));
            
            // Remove draft for this date
            localStorage.removeItem(`draft_${entryDate}`);
            
            showSuccessMessage();
            updateStats();
            renderCalendar();
            
            // Clear for next entry only if it's today's entry
            const today = new Date().toISOString().split('T')[0];
            if (entryDate === today) {
                setTimeout(() => {
                    editor.innerHTML = '';
                    removePhoto();
                    updateWordCount();
                    resetTimer();
                }, 1500);
            }
        }

        function autoSave() {
            const editor = document.getElementById('journalEntry');
            const html = editor.innerHTML.trim();
            const text = editor.textContent.trim();
            
            if (text) {
                const entryDate = currentEntryDate || new Date().toISOString().split('T')[0];
                const draft = { 
                    html, 
                    text,
                    photo: currentPhoto,
                    timestamp: new Date().toISOString() 
                };
                localStorage.setItem(`draft_${entryDate}`, JSON.stringify(draft));
            }
        }

        function checkTodayEntry() {
            const today = new Date().toISOString().split('T')[0];
            loadEntryForDate(today);
        }

        function formatDateInEnglish(dateString) {
            const date = new Date(dateString);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            return {
                full: `${weekdays[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`,
                short: `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`,
                display: `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`
            };
        }

        function initializeSpellChecker() {
            try {
                // Initialize Typo.js with US English dictionary
                spellChecker = new Typo("en_US", false, false, {
                    dictionaryPath: "https://cdn.jsdelivr.net/npm/typo-js@1.2.1/dictionaries"
                });
                console.log('✓ Spell checker initialized');
            } catch (error) {
                console.log('Spell checker not available:', error);
            }
        }

        function checkSpelling() {
            const editor = document.getElementById('journalEntry');
            const text = editor.textContent;
            
            if (!text || text.length < 2) return;
            
            // Save cursor position BEFORE making changes
            const selection = window.getSelection();
            let cursorNode = null;
            let cursorOffset = 0;
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                cursorNode = range.startContainer;
                cursorOffset = range.startOffset;
            }
            
            // Calculate absolute cursor position in text
            let absoluteCursorPos = 0;
            if (cursorNode) {
                const walker = document.createTreeWalker(
                    editor,
                    NodeFilter.SHOW_TEXT,
                    null
                );
                
                let currentPos = 0;
                while (walker.nextNode()) {
                    if (walker.currentNode === cursorNode) {
                        absoluteCursorPos = currentPos + cursorOffset;
                        break;
                    }
                    currentPos += walker.currentNode.textContent.length;
                }
            }
            
            // Remove old highlights
            const oldHighlights = editor.querySelectorAll('.spelling-error');
            oldHighlights.forEach(el => {
                const text = el.textContent;
                el.replaceWith(document.createTextNode(text));
            });
            
            // Normalize text nodes
            editor.normalize();
            
            // Check each word and add highlights
            const walker = document.createTreeWalker(
                editor,
                NodeFilter.SHOW_TEXT,
                null
            );
            
            const nodesToProcess = [];
            while (walker.nextNode()) {
                nodesToProcess.push(walker.currentNode);
            }
            
            nodesToProcess.forEach(node => {
                if (!node.parentNode || node.parentNode.classList?.contains('spelling-error')) return;
                
                const text = node.textContent;
                const words = text.match(/\b[a-zA-Z]+\b/g);
                
                if (!words) return;
                
                let html = text;
                const wordsToHighlight = [];
                
                words.forEach(word => {
                    if (word.length > 1 && !ignoredWords.has(word.toLowerCase())) {
                        const isCorrect = spellChecker.check(word);
                        if (!isCorrect) {
                            wordsToHighlight.push(word);
                        }
                    }
                });
                
                if (wordsToHighlight.length > 0) {
                    wordsToHighlight.forEach(word => {
                        const regex = new RegExp(`\\b${word}\\b`, 'g');
                        html = html.replace(regex, `<span class="spelling-error" data-word="${word}">${word}</span>`);
                    });
                    
                    const template = document.createElement('template');
                    template.innerHTML = html;
                    
                    const parent = node.parentNode;
                    const fragment = template.content;
                    parent.replaceChild(fragment, node);
                }
            });
            
            // RESTORE cursor position
            if (absoluteCursorPos > 0) {
                try {
                    const walker = document.createTreeWalker(
                        editor,
                        NodeFilter.SHOW_TEXT,
                        null
                    );
                    
                    let currentPos = 0;
                    while (walker.nextNode()) {
                        const node = walker.currentNode;
                        const nodeLength = node.textContent.length;
                        
                        if (currentPos + nodeLength >= absoluteCursorPos) {
                            const offset = absoluteCursorPos - currentPos;
                            const newRange = document.createRange();
                            newRange.setStart(node, Math.min(offset, nodeLength));
                            newRange.collapse(true);
                            
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                            break;
                        }
                        
                        currentPos += nodeLength;
                    }
                } catch (e) {
                    // If cursor restoration fails, just continue
                    console.log('Could not restore cursor:', e);
                }
            }
        }

        function handleSpellContextMenu(e) {
            const target = e.target;
            
            if (target.classList.contains('spelling-error')) {
                e.preventDefault();
                
                const word = target.dataset.word;
                if (word && spellChecker) {
                    const suggestions = spellChecker.suggest(word);
                    showSpellMenu(e.clientX, e.clientY, word, suggestions, target);
                }
            }
        }

        function showSpellMenu(x, y, word, suggestions, targetElement) {
            closeSpellMenu();
            
            const menu = document.createElement('div');
            menu.className = 'spell-menu';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            
            // Add suggestions (max 5)
            const topSuggestions = suggestions.slice(0, 5);
            if (topSuggestions.length > 0) {
                topSuggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'spell-menu-item';
                    
                    const span = document.createElement('span');
                    span.className = 'spell-menu-suggestion';
                    span.textContent = suggestion;
                    item.appendChild(span);
                    
                    item.addEventListener('click', () => {
                        replaceSpellingError(targetElement, suggestion);
                        closeSpellMenu();
                    });
                    
                    menu.appendChild(item);
                });
            } else {
                const item = document.createElement('div');
                item.className = 'spell-menu-item';
                item.style.color = '#999';
                item.textContent = 'No suggestions';
                menu.appendChild(item);
            }
            
            // Add ignore option
            const ignoreItem = document.createElement('div');
            ignoreItem.className = 'spell-menu-item spell-menu-ignore';
            ignoreItem.textContent = 'Ignore';
            ignoreItem.addEventListener('click', () => {
                ignoredWords.add(word.toLowerCase());
                targetElement.classList.remove('spelling-error');
                targetElement.outerHTML = targetElement.textContent;
                closeSpellMenu();
            });
            menu.appendChild(ignoreItem);
            
            document.body.appendChild(menu);
            currentSpellMenu = menu;
            
            // Adjust position if menu goes off screen
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = (x - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = (y - rect.height) + 'px';
            }
        }

        function closeSpellMenu() {
            if (currentSpellMenu) {
                currentSpellMenu.remove();
                currentSpellMenu = null;
            }
        }

        function replaceSpellingError(element, replacement) {
            element.textContent = replacement;
            element.classList.remove('spelling-error');
            element.outerHTML = element.textContent;
        }

        function loadEntryForDate(date) {
            const entries = getEntries();
            const editor = document.getElementById('journalEntry');
            
            // Check for saved entry first
            if (entries[date]) {
                const entry = entries[date];
                editor.innerHTML = entry.html || entry.text;
                if (entry.photo) {
                    currentPhoto = entry.photo;
                    displayPhoto(entry.photo);
                } else {
                    removePhoto();
                }
                updateWordCount();
                return;
            }
            
            // Check for draft
            const draft = localStorage.getItem(`draft_${date}`);
            if (draft) {
                const { html, photo } = JSON.parse(draft);
                editor.innerHTML = html;
                if (photo) {
                    currentPhoto = photo;
                    displayPhoto(photo);
                } else {
                    removePhoto();
                }
                updateWordCount();
            } else {
                // Clear editor if no entry or draft
                editor.innerHTML = '';
                removePhoto();
                updateWordCount();
            }
        }

        function showSuccessMessage() {
            const msg = document.getElementById('successMessage');
            const entries = getEntries();
            const streak = calculateStreak(entries);
            
            let text = 'Entry saved!';
            if (streak === 1) text = 'Entry saved! Start of your journey.';
            else if (streak === 7) text = 'Entry saved! One week streak!';
            else if (streak === 30) text = 'Entry saved! 30 days strong!';
            else if (streak % 10 === 0) text = `Entry saved! ${streak} day streak!`;
            
            document.getElementById('successText').textContent = text;
            msg.style.display = 'block';
            
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
        }

        function getEntries() {
            return JSON.parse(localStorage.getItem('journalEntries') || '{}');
        }

        function updateStats() {
            const entries = getEntries();
            const dates = Object.keys(entries).sort();
            
            document.getElementById('streakCount').textContent = calculateStreak(entries);
            document.getElementById('totalEntries').textContent = dates.length;
            
            const totalWords = dates.reduce((sum, date) => 
                sum + (entries[date].wordCount || 0), 0);
            document.getElementById('totalWords').textContent = totalWords.toLocaleString();
        }

        function calculateStreak(entries) {
            const dates = Object.keys(entries).sort().reverse();
            if (dates.length === 0) return 0;
            
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < dates.length; i++) {
                const entryDate = new Date(dates[i]);
                entryDate.setHours(0, 0, 0, 0);
                
                const expectedDate = new Date(today);
                expectedDate.setDate(expectedDate.getDate() - i);
                expectedDate.setHours(0, 0, 0, 0);
                
                if (entryDate.getTime() === expectedDate.getTime()) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const entries = getEntries();
            const today = new Date();
            
            for (let i = 59; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.dataset.date = dateStr;
                
                if (entries[dateStr]) {
                    day.classList.add('written');
                    day.title = `${entries[dateStr].wordCount} words`;
                }
                
                if (i === 0) {
                    day.classList.add('today');
                }
                
                grid.appendChild(day);
            }
        }

        function openHistoryModal() {
            document.getElementById('historyModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadEntries();
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function loadEntries(searchTerm = '') {
            const entries = getEntries();
            const entriesList = document.getElementById('entriesList');
            const dates = Object.keys(entries).sort().reverse();
            
            if (dates.length === 0) {
                entriesList.innerHTML = `
                    <div class="no-entries">
                        <div class="no-entries-icon">📝</div>
                        <h3>No entries yet</h3>
                        <p>Start writing to see your journal history here!</p>
                    </div>
                `;
                return;
            }

            const filteredDates = searchTerm 
                ? dates.filter(date => entries[date].text.toLowerCase().includes(searchTerm.toLowerCase()))
                : dates;

            if (filteredDates.length === 0) {
                entriesList.innerHTML = `
                    <div class="no-entries">
                        <div class="no-entries-icon">🔍</div>
                        <h3>No matches found</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
                return;
            }

            entriesList.innerHTML = filteredDates.map(date => {
                const entry = entries[date];
                const formattedDate = formatDateInEnglish(date).full;
                
                const photoHTML = entry.photo ? `<img src="${entry.photo}" alt="Journal photo">` : '';
                const contentHTML = entry.html || entry.text;
                
                return `
                    <div class="entry-card" data-date="${date}">
                        <div class="entry-header">
                            <div class="entry-date">${formattedDate}</div>
                            <div class="entry-meta">${entry.wordCount || 0} words</div>
                        </div>
                        <div class="entry-preview">${photoHTML}${contentHTML}</div>
                        <div class="entry-actions">
                            <button class="entry-btn edit-btn" onclick="editEntry('${date}')">Edit</button>
                            <button class="entry-btn delete-btn" onclick="deleteEntry('${date}')">Delete</button>
                            <button class="entry-btn collapse-btn" onclick="collapseEntry('${date}')">Collapse</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers to expand entries
            document.querySelectorAll('.entry-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('entry-btn')) {
                        card.classList.toggle('expanded');
                    }
                });
            });
        }

        function filterEntries() {
            const searchTerm = document.getElementById('searchInput').value;
            loadEntries(searchTerm);
        }

        function editEntry(date) {
            const entries = getEntries();
            const entry = entries[date];
            
            if (confirm('Load this entry for editing? (Your current draft will be replaced)')) {
                const editor = document.getElementById('journalEntry');
                editor.innerHTML = entry.html || entry.text;
                
                if (entry.photo) {
                    currentPhoto = entry.photo;
                    displayPhoto(entry.photo);
                }
                
                // Update date picker to the entry's date
                document.getElementById('entryDate').value = date;
                currentEntryDate = date;
                
                updateWordCount();
                closeHistoryModal();
                
                // Scroll to writing area
                editor.scrollIntoView({ behavior: 'smooth' });
                editor.focus();
            }
        }

        function deleteEntry(date) {
            const entries = getEntries();
            const formattedDate = formatDateInEnglish(date).short;
            
            if (confirm(`Are you sure you want to delete your entry from ${formattedDate}? This cannot be undone.`)) {
                delete entries[date];
                localStorage.setItem('journalEntries', JSON.stringify(entries));
                
                loadEntries(document.getElementById('searchInput').value);
                updateStats();
                renderCalendar();
            }
        }

        function collapseEntry(date) {
            const card = document.querySelector(`[data-date="${date}"]`);
            if (card) {
                card.classList.remove('expanded');
            }
        }

        function loadData() {
            // Migration from old storage if needed
            const oldEntry = localStorage.getItem('todayEntry');
            if (oldEntry) {
                const today = new Date().toISOString().split('T')[0];
                const entries = getEntries();
                if (!entries[today]) {
                    entries[today] = {
                        text: oldEntry,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('journalEntries', JSON.stringify(entries));
                }
                localStorage.removeItem('todayEntry');
            }
        }

        // ========== PROJECTS FUNCTIONS ==========

        function getProjects() {
            return JSON.parse(localStorage.getItem('journalProjects') || '{}');
        }

        function saveProjects(projects) {
            localStorage.setItem('journalProjects', JSON.stringify(projects));
        }

        function openProjectsModal() {
            document.getElementById('projectsModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadProjects();
        }

        function closeProjectsModal() {
            document.getElementById('projectsModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function loadProjects() {
            const projects = getProjects();
            const projectsList = document.getElementById('projectsList');
            const projectIds = Object.keys(projects).sort((a, b) => {
                return new Date(projects[b].createdAt) - new Date(projects[a].createdAt);
            });

            // Filter projects
            const filteredIds = projectIds.filter(id => {
                const project = projects[id];
                if (currentProjectFilter === 'all') return true;
                if (currentProjectFilter === 'active') return project.status === 'active';
                if (currentProjectFilter === 'solved') return project.status === 'solved';
                return true;
            });

            if (filteredIds.length === 0) {
                projectsList.innerHTML = `
                    <div class="no-entries">
                        <div class="no-entries-icon">💡</div>
                        <h3>No projects yet</h3>
                        <p>Click "New Project" to start tracking your ideas and problems!</p>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = filteredIds.map(id => {
                const project = projects[id];
                
                // Count items in each section
                const situationCount = project.situation ? 1 : 0;
                const ideasCount = project.ideas ? project.ideas.length : 0;
                const actionsCount = project.actions ? project.actions.length : 0;
                const progressCount = project.progress ? project.progress.length : 0;
                
                const totalItems = situationCount + ideasCount + actionsCount + progressCount;
                const lastUpdated = project.updatedAt 
                    ? new Date(project.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    : new Date(project.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <div class="project-card ${project.status}" data-project-id="${id}">
                        <div class="project-header">
                            <div class="project-title">${project.title}</div>
                            <div class="project-status ${project.status}">${project.status}</div>
                        </div>
                        ${project.goal ? `<div class="project-goal">🎯 ${project.goal}</div>` : ''}
                        <div class="project-stats">
                            <span class="stat-badge">💡 ${ideasCount} ideas</span>
                            <span class="stat-badge">✅ ${actionsCount} actions</span>
                            <span class="stat-badge">📊 ${progressCount} updates</span>
                        </div>
                        <div class="project-meta">Last updated: ${lastUpdated}</div>
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.project-card').forEach(card => {
                card.addEventListener('click', () => {
                    openProjectDetail(card.dataset.projectId);
                });
            });
        }

        function createNewProject() {
            console.log('Creating new project...');
            
            const projects = getProjects();
            const projectId = 'project_' + Date.now();
            
            // Create blank project
            projects[projectId] = {
                title: 'Untitled Project',
                status: 'active',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                goal: '',
                situation: '',
                ideas: [],
                actions: [],
                progress: []
            };

            console.log('Saving project:', projects[projectId]);
            saveProjects(projects);
            
            // Close projects list and open the blank canvas
            closeProjectsModal();
            openProjectDetail(projectId);
            
            // Focus on title so user can rename
            setTimeout(() => {
                const titleElement = document.getElementById('projectDetailTitle');
                if (titleElement) {
                    titleElement.focus();
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(titleElement);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }, 100);
            
            console.log('Project created successfully!');
        }

        function openProjectDetail(projectId) {
            currentProjectId = projectId;
            const projects = getProjects();
            const project = projects[projectId];

            if (!project) return;

            document.getElementById('projectDetailTitle').textContent = project.title;
            document.getElementById('projectDetailModal').classList.add('active');
            
            // Update button text based on status
            const solvedBtn = document.getElementById('markSolvedBtn');
            solvedBtn.textContent = project.status === 'solved' ? '↩ Reopen' : '✓ Solved';

            loadProjectCanvas(projectId);
        }

        function updateProjectTitle(projectId, newTitle) {
            if (!projectId) return;
            
            const projects = getProjects();
            const project = projects[projectId];
            
            const trimmedTitle = newTitle.trim();
            if (trimmedTitle && trimmedTitle !== project.title) {
                project.title = trimmedTitle;
                project.updatedAt = new Date().toISOString();
                saveProjects(projects);
            } else if (!trimmedTitle) {
                // If empty, restore original title
                document.getElementById('projectDetailTitle').textContent = project.title;
            }
        }

        function closeProjectDetailModal() {
            document.getElementById('projectDetailModal').classList.remove('active');
            currentProjectId = null;
            loadProjects(); // Refresh the projects list
        }

        function loadProjectCanvas(projectId) {
            const projects = getProjects();
            const project = projects[projectId];
            const canvas = document.getElementById('projectCanvas');

            let html = '';

            // Goal Section - Click to edit
            html += `
                <div class="canvas-section">
                    <div class="canvas-section-header">
                        <div class="canvas-section-title">🎯 Goal / Objective</div>
                    </div>
                    <div class="canvas-toolbar" id="goalToolbar">
                        <button class="canvas-toolbar-btn" data-format="title" onclick="applyCanvasFormat('goal', 'h1')">Title</button>
                        <button class="canvas-toolbar-btn" data-format="subtitle" onclick="applyCanvasFormat('goal', 'h2')">Subtitle</button>
                        <button class="canvas-toolbar-btn" data-format="heading" onclick="applyCanvasFormat('goal', 'h3')">Heading</button>
                        <button class="canvas-toolbar-btn" data-format="normal" onclick="applyCanvasFormat('goal', 'p')">Normal</button>
                        <button class="canvas-toolbar-btn" data-format="bold" onclick="applyCanvasFormat('goal', 'bold')">B</button>
                        <button class="canvas-toolbar-btn" data-format="italic" onclick="applyCanvasFormat('goal', 'italic')">/</button>
                        <button class="canvas-toolbar-btn" data-format="quote" onclick="applyCanvasFormat('goal', 'blockquote')">Quote</button>
                    </div>
                    <div class="canvas-section-content" 
                         contenteditable="true" 
                         id="goalContent"
                         data-placeholder="Click to write your goal... What are you trying to achieve?"
                         onfocus="showCanvasToolbar('goal')"
                         onblur="saveProjectField('${projectId}', 'goal', this.innerHTML)">${project.goal || ''}</div>
                </div>
            `;

            // Current Situation - Click to edit
            html += `
                <div class="canvas-section">
                    <div class="canvas-section-header">
                        <div class="canvas-section-title">🤔 Current Situation</div>
                    </div>
                    <div class="canvas-toolbar" id="situationToolbar">
                        <button class="canvas-toolbar-btn" data-format="title" onclick="applyCanvasFormat('situation', 'h1')">Title</button>
                        <button class="canvas-toolbar-btn" data-format="subtitle" onclick="applyCanvasFormat('situation', 'h2')">Subtitle</button>
                        <button class="canvas-toolbar-btn" data-format="heading" onclick="applyCanvasFormat('situation', 'h3')">Heading</button>
                        <button class="canvas-toolbar-btn" data-format="normal" onclick="applyCanvasFormat('situation', 'p')">Normal</button>
                        <button class="canvas-toolbar-btn" data-format="bold" onclick="applyCanvasFormat('situation', 'bold')">B</button>
                        <button class="canvas-toolbar-btn" data-format="italic" onclick="applyCanvasFormat('situation', 'italic')">/</button>
                        <button class="canvas-toolbar-btn" data-format="quote" onclick="applyCanvasFormat('situation', 'blockquote')">Quote</button>
                    </div>
                    <div class="canvas-section-content" 
                         contenteditable="true"
                         id="situationContent"
                         data-placeholder="Click to describe the current state... What's the problem or challenge?"
                         onfocus="showCanvasToolbar('situation')"
                         onblur="saveProjectField('${projectId}', 'situation', this.innerHTML)">${project.situation || ''}</div>
                </div>
            `;

            // Ideas - List with add button
            html += `
                <div class="canvas-section">
                    <div class="canvas-section-header">
                        <div class="canvas-section-title">💡 Ideas & Options</div>
                    </div>
                    <div class="canvas-list-section">
                        ${project.ideas && project.ideas.length > 0 
                            ? project.ideas.map((idea, index) => `
                                <div class="canvas-item idea">
                                    <div class="canvas-item-content" 
                                         contenteditable="true"
                                         onblur="updateProjectItem('${projectId}', 'ideas', ${index}, this.textContent)">${idea.content}</div>
                                    <div class="canvas-item-meta">
                                        <span>${formatDateInEnglish(idea.timestamp.split('T')[0]).short}</span>
                                        <div class="canvas-item-actions">
                                            <button class="canvas-item-btn delete-item-btn" onclick="deleteProjectItem('${projectId}', 'ideas', ${index})">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')
                            : ''
                        }
                        <div class="add-item-btn" onclick="addNewProjectItem('${projectId}', 'ideas')">
                            + Add idea or option
                        </div>
                    </div>
                </div>
            `;

            // Actions - List with add button and done toggle
            html += `
                <div class="canvas-section">
                    <div class="canvas-section-header">
                        <div class="canvas-section-title">✅ Actions & Next Steps</div>
                    </div>
                    <div class="canvas-list-section">
                        ${project.actions && project.actions.length > 0 
                            ? project.actions.map((action, index) => `
                                <div class="canvas-item action ${action.done ? 'done' : ''}">
                                    <div class="canvas-item-content" 
                                         contenteditable="true"
                                         onblur="updateProjectItem('${projectId}', 'actions', ${index}, this.textContent)">${action.content}</div>
                                    <div class="canvas-item-meta">
                                        <span>${formatDateInEnglish(action.timestamp.split('T')[0]).short}</span>
                                        <div class="canvas-item-actions">
                                            <button class="canvas-item-btn toggle-action-btn" onclick="toggleAction('${projectId}', ${index})">${action.done ? '↩ Undo' : '✓ Done'}</button>
                                            <button class="canvas-item-btn delete-item-btn" onclick="deleteProjectItem('${projectId}', 'actions', ${index})">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')
                            : ''
                        }
                        <div class="add-item-btn" onclick="addNewProjectItem('${projectId}', 'actions')">
                            + Add action or next step
                        </div>
                    </div>
                </div>
            `;

            // Progress Log - Newest first
            html += `
                <div class="canvas-section">
                    <div class="canvas-section-header">
                        <div class="canvas-section-title">📊 Progress & Updates</div>
                    </div>
                    <div class="canvas-list-section">
                        ${project.progress && project.progress.length > 0 
                            ? project.progress.slice().reverse().map((update, index) => {
                                const realIndex = project.progress.length - 1 - index;
                                return `
                                <div class="canvas-item progress">
                                    <div class="canvas-item-content" 
                                         contenteditable="true"
                                         onblur="updateProjectItem('${projectId}', 'progress', ${realIndex}, this.textContent)">${update.content}</div>
                                    <div class="canvas-item-meta">
                                        <span>${formatDateInEnglish(update.timestamp.split('T')[0]).short}</span>
                                        <div class="canvas-item-actions">
                                            <button class="canvas-item-btn delete-item-btn" onclick="deleteProjectItem('${projectId}', 'progress', ${realIndex})">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')
                            : ''
                        }
                        <div class="add-item-btn" onclick="addNewProjectItem('${projectId}', 'progress')">
                            + Log progress or update
                        </div>
                    </div>
                </div>
            `;

            // Free-form Notes Section - For open writing
            html += `
                <div class="canvas-section">
                    <div class="canvas-section-header">
                        <div class="canvas-section-title">📝 Notes & Thoughts</div>
                    </div>
                    <div class="canvas-toolbar" id="notesToolbar">
                        <button class="canvas-toolbar-btn" onclick="applyNotesFormat('h1')">Title</button>
                        <button class="canvas-toolbar-btn" onclick="applyNotesFormat('h2')">Subtitle</button>
                        <button class="canvas-toolbar-btn" onclick="applyNotesFormat('h3')">Heading</button>
                        <button class="canvas-toolbar-btn" onclick="applyNotesFormat('p')">Normal</button>
                        <button class="canvas-toolbar-btn" onclick="applyNotesFormat('bold')">B</button>
                        <button class="canvas-toolbar-btn" onclick="applyNotesFormat('italic')">/</button>
                        <button class="canvas-toolbar-btn" onclick="applyNotesFormat('blockquote')">Quote</button>
                    </div>
                    <div class="canvas-section-content project-freeform-notes" 
                         contenteditable="true" 
                         id="notesContent"
                         spellcheck="true"
                         data-placeholder="Write freely here... reflections, random thoughts, brainstorming, anything..."
                         onfocus="showCanvasToolbar('notes')"
                         onblur="saveProjectField('${projectId}', 'notes', this.innerHTML)"
                         oninput="updateProjectWordCount('${projectId}')"
                         style="min-height: 200px;">${project.notes || ''}</div>
                    <div class="project-notes-word-count" id="projectWordCount-${projectId}" style="text-align: right; color: #999; font-size: 0.85em; margin-top: 8px;">0 words</div>
                </div>
            `;

            canvas.innerHTML = html;
            
            // Update word count
            updateProjectWordCount(projectId);
        }

        function applyNotesFormat(format) {
            const content = document.getElementById('notesContent');
            if (!content) return;
            
            content.focus();
            
            if (format === 'bold') {
                document.execCommand('bold', false, null);
            } else if (format === 'italic') {
                document.execCommand('italic', false, null);
            } else if (format === 'h1' || format === 'h2' || format === 'h3' || format === 'p') {
                document.execCommand('formatBlock', false, format);
            } else if (format === 'blockquote') {
                document.execCommand('formatBlock', false, 'blockquote');
            }
        }

        function saveProjectField(projectId, field, content) {
            const projects = getProjects();
            const project = projects[projectId];
            
            if (field === 'notes') {
                // Save HTML for rich text
                project[field] = content;
            } else {
                project[field] = content.trim();
            }
            
            project.updatedAt = new Date().toISOString();
            saveProjects(projects);
        }

        function updateProjectWordCount(projectId) {
            const notesElement = document.querySelector('.project-freeform-notes');
            const countElement = document.getElementById(`projectWordCount-${projectId}`);
            
            if (notesElement && countElement) {
                const text = notesElement.textContent || notesElement.innerText || '';
                const words = text.trim().split(/\s+/).filter(word => word.length > 0);
                const wordCount = text.trim().length === 0 ? 0 : words.length;
                countElement.textContent = `${wordCount} word${wordCount !== 1 ? 's' : ''}`;
            }
        }

        function showCanvasToolbar(section) {
            const toolbar = document.getElementById(section + 'Toolbar');
            if (toolbar) {
                toolbar.classList.add('active');
            }
        }

        function applyCanvasFormat(section, format) {
            const content = document.getElementById(section + 'Content');
            if (!content) return;
            
            content.focus();
            
            if (format === 'bold') {
                document.execCommand('bold', false, null);
            } else if (format === 'italic') {
                document.execCommand('italic', false, null);
            } else if (format === 'h1' || format === 'h2' || format === 'h3' || format === 'p') {
                document.execCommand('formatBlock', false, format);
            } else if (format === 'blockquote') {
                document.execCommand('formatBlock', false, 'blockquote');
            }
        }

        function addNewProjectItem(projectId, type) {
            const projects = getProjects();
            const project = projects[projectId];
            
            if (!project[type]) project[type] = [];
            
            const newItem = {
                content: '',
                timestamp: new Date().toISOString()
            };
            
            if (type === 'actions') {
                newItem.done = false;
            }
            
            project[type].push(newItem);
            project.updatedAt = new Date().toISOString();
            
            saveProjects(projects);
            loadProjectCanvas(projectId);
            
            // Focus the new item
            setTimeout(() => {
                const items = document.querySelectorAll('.canvas-item-content');
                if (items.length > 0) {
                    const lastItem = type === 'progress' ? items[0] : items[items.length - 1];
                    lastItem.focus();
                }
            }, 100);
        }

        function updateProjectItem(projectId, type, index, content) {
            const projects = getProjects();
            const project = projects[projectId];
            
            if (project[type] && project[type][index]) {
                project[type][index].content = content.trim();
                project.updatedAt = new Date().toISOString();
                saveProjects(projects);
            }
        }

        function deleteProjectItem(projectId, type, index) {
            if (!confirm('Delete this item?')) return;
            
            const projects = getProjects();
            const project = projects[projectId];
            
            project[type].splice(index, 1);
            project.updatedAt = new Date().toISOString();
            
            saveProjects(projects);
            loadProjectCanvas(projectId);
        }

        function toggleAction(projectId, actionIndex) {
            const projects = getProjects();
            const project = projects[projectId];
            
            project.actions[actionIndex].done = !project.actions[actionIndex].done;
            project.updatedAt = new Date().toISOString();
            
            saveProjects(projects);
            loadProjectCanvas(projectId);
        }

        function toggleProjectStatus() {
            if (!currentProjectId) return;

            const projects = getProjects();
            const project = projects[currentProjectId];

            project.status = project.status === 'active' ? 'solved' : 'active';
            project.updatedAt = new Date().toISOString();

            saveProjects(projects);
            
            // Update button text
            const solvedBtn = document.getElementById('markSolvedBtn');
            solvedBtn.textContent = project.status === 'solved' ? '↩ Reopen' : '✓ Solved';
            
            loadProjectCanvas(currentProjectId);
        }

        function deleteProject() {
            if (!currentProjectId) return;

            const projects = getProjects();
            const project = projects[currentProjectId];

            if (!confirm(`Delete "${project.title}"? This cannot be undone.`)) return;

            delete projects[currentProjectId];
            saveProjects(projects);
            
            closeProjectDetailModal();
            closeProjectsModal();
        }
    </script>
</body>
</html>
